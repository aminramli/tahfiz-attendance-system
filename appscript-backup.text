// ============================================
// SISTEM KEHADIRAN TAHFIZ - GOOGLE APPS SCRIPT
// ============================================
// Fail ini mengandungi semua kod backend untuk Google Apps Script
// Upload fail ini ke Google Apps Script Editor anda

// ============================================
// 1. Code.gs (Main Backend File)
// ============================================

// Configuration
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE'; // Ganti dengan ID Google Sheet anda
const SHEET_USERS = 'Users';
const SHEET_ATTENDANCE = 'Attendance';
const SHEET_SETTINGS = 'Settings';
const SHEET_NOTES = 'Notes';

// GPS Settings (Koordinat Tahfiz)
const TAHFIZ_LAT = 3.1390; // Ganti dengan koordinat tahfiz anda
const TAHFIZ_LNG = 101.6869;
const ALLOWED_RADIUS = 200; // 200 meter radius

/**
 * Handle GET requests (API endpoints)
 * Frontend menggunakan GET request dengan query parameters
 */
function doGet(e) {
  try {
    const action = e.parameter.action;

    // Jika tiada action, return error
    if (!action) {
      return createResponse(false, 'Action parameter diperlukan');
    }

    // Handle different actions
    switch(action) {
      case 'login':
        return handleLogin(e.parameter);
      case 'checkIn':
        return handleCheckIn(e.parameter);
      case 'checkOut':
        return handleCheckOut(e.parameter);
      case 'getAttendance':
        return getAttendanceRecords(e.parameter);
      case 'getUserStats':
        return getUserStats(e.parameter);
      case 'addUser':
        return addUser(e.parameter);
      case 'updateUser':
        return updateUser(e.parameter);
      case 'deleteUser':
        return deleteUser(e.parameter);
      case 'getAllUsers':
        return getAllUsers();
      case 'getTodayAttendance':
        return getTodayAttendance();
      case 'getUser':
        return getUser(e.parameter);
      case 'submitNote':
        return submitNote(e.parameter);
      case 'getAllNotes':
        return getAllNotes();
      case 'getNotesByUser':
        return getNotesByUser(e.parameter);
      default:
        return createResponse(false, 'Invalid action: ' + action);
    }
  } catch (error) {
    Logger.log('Error in doGet: ' + error.message);
    Logger.log('Stack: ' + error.stack);
    return createResponse(false, 'Error: ' + error.message);
  }
}

/**
 * Handle POST requests (for backwards compatibility)
 */
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const action = params.action;

    switch(action) {
      case 'login':
        return handleLogin(params);
      case 'checkIn':
        return handleCheckIn(params);
      case 'checkOut':
        return handleCheckOut(params);
      case 'getAttendance':
        return getAttendanceRecords(params);
      case 'getUserStats':
        return getUserStats(params);
      case 'addUser':
        return addUser(params);
      case 'updateUser':
        return updateUser(params);
      case 'deleteUser':
        return deleteUser(params);
      case 'getAllUsers':
        return getAllUsers();
      default:
        return createResponse(false, 'Invalid action');
    }
  } catch (error) {
    return createResponse(false, 'Error: ' + error.message);
  }
}

/**
 * Create standardized JSON response
 */
function createResponse(success, message, data = null) {
  const response = {
    success: success,
    message: message,
    timestamp: new Date().toISOString()
  };

  if (data !== null) {
    response.data = data;
  }

  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Get spreadsheet
 */
function getSpreadsheet() {
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

/**
 * Get sheet by name
 */
function getSheet(sheetName) {
  const ss = getSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);

  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    initializeSheet(sheet, sheetName);
  }

  return sheet;
}

/**
 * Generate 6 digit user ID
 */
function generateUserId() {
  // Generate random 6 digit number
  return String(Math.floor(100000 + Math.random() * 900000));
}

/**
 * Initialize sheet with headers
 */
function initializeSheet(sheet, sheetName) {
  if (sheetName === SHEET_USERS) {
    // Column structure: UserID (6 digit) | Email | Password | Nama | Role | Status | Created | LastLogin
    sheet.appendRow(['UserID', 'Email', 'Password', 'Nama', 'Role', 'Status', 'Created', 'LastLogin']);

    // Add default admin account
    const adminPassword = hashPassword('admin123');
    sheet.appendRow([
      '999999',  // Fixed admin ID
      'admin@mrsmatra.edu.my',
      adminPassword,
      'Administrator',
      'admin',
      'Active',
      new Date().toISOString(),
      ''
    ]);

    // Add default guru account
    const guruPassword = hashPassword('guru123');
    sheet.appendRow([
      '100001',  // Fixed guru ID
      'guru@mrsmatra.edu.my',
      guruPassword,
      'Guru Contoh',
      'guru',
      'Active',
      new Date().toISOString(),
      ''
    ]);

    // Add sample teacher accounts
    const teacher2Password = hashPassword('guru123');
    sheet.appendRow([
      '100002',
      'ahmad@mrsmatra.edu.my',
      teacher2Password,
      'Ahmad bin Abdullah',
      'guru',
      'Active',
      new Date().toISOString(),
      ''
    ]);

  } else if (sheetName === SHEET_ATTENDANCE) {
    sheet.appendRow([
      'ID',
      'UserID',
      'UserName',
      'Email',
      'Date',
      'CheckIn',
      'CheckOut',
      'CheckInLat',
      'CheckInLng',
      'CheckOutLat',
      'CheckOutLng',
      'Duration',
      'Status',
      'Notes'
    ]);

  } else if (sheetName === SHEET_SETTINGS) {
    sheet.appendRow(['Key', 'Value', 'Description']);
    sheet.appendRow(['tahfiz_lat', TAHFIZ_LAT, 'Latitude MRSM Matra']);
    sheet.appendRow(['tahfiz_lng', TAHFIZ_LNG, 'Longitude MRSM Matra']);
    sheet.appendRow(['allowed_radius', ALLOWED_RADIUS, 'Radius dibenarkan (meter)']);

  } else if (sheetName === SHEET_NOTES) {
    sheet.appendRow([
      'ID',
      'UserID',
      'UserName',
      'Email',
      'NoteType',
      'NoteDate',
      'NoteReason',
      'SubmittedDate',
      'Status',
      'AdminResponse',
      'AdminRespondedDate'
    ]);
  }
}

/**
 * Generate unique ID
 */
function generateId() {
  return 'ID' + new Date().getTime() + Math.random().toString(36).substr(2, 9);
}

/**
 * Hash password (simple hash - untuk production guna library yang lebih selamat)
 */
function hashPassword(password) {
  return Utilities.base64Encode(Utilities.computeDigest(
    Utilities.DigestAlgorithm.SHA_256,
    password + 'TAHFIZ_SALT_2024'
  ));
}

/**
 * Verify password
 */
function verifyPassword(password, hash) {
  return hashPassword(password) === hash;
}

/**
 * Handle login - Support both userId (6 digit) and email
 */
function handleLogin(params) {
  const userId = params.userId;
  const email = params.email;
  const password = params.password;

  // Must have either userId or email, and password
  if ((!userId && !email) || !password) {
    return createResponse(false, 'ID Pengguna/Email dan password diperlukan');
  }

  const sheet = getSheet(SHEET_USERS);
  const data = sheet.getDataRange().getValues();

  Logger.log('Login attempt - userId: ' + userId + ', email: ' + email);

  // Skip header row
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const rowUserId = row[0]; // Column A: UserID (6 digit)
    const rowEmail = row[1];  // Column B: Email
    const rowPassword = row[2]; // Column C: Password
    const rowName = row[3];   // Column D: Name
    const rowRole = row[4];   // Column E: Role
    const rowStatus = row[5]; // Column F: Status

    // Check if user matches (by userId or email) and is Active
    const userMatches = (userId && rowUserId === userId) || (email && rowEmail === email);

    if (userMatches && rowStatus === 'Active') {
      // Verify password
      if (verifyPassword(password, rowPassword)) {
        // Update last login (Column H)
        sheet.getRange(i + 1, 8).setValue(new Date().toISOString());

        Logger.log('Login successful for: ' + rowName);

        return createResponse(true, 'Login berjaya', {
          id: rowUserId,
          userId: rowUserId,
          email: rowEmail || '',
          name: rowName,
          role: rowRole,
          status: rowStatus
        });
      } else {
        Logger.log('Password mismatch for user: ' + rowUserId);
      }
    }
  }

  Logger.log('Login failed - user not found or password incorrect');
  return createResponse(false, 'ID Pengguna atau password salah');
}

/**
 * Calculate distance between two coordinates (Haversine formula)
 */
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Earth radius in meters
  const �1 = lat1 * Math.PI / 180;
  const �2 = lat2 * Math.PI / 180;
  const �� = (lat2 - lat1) * Math.PI / 180;
  const �� = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(��/2) * Math.sin(��/2) +
            Math.cos(�1) * Math.cos(�2) *
            Math.sin(��/2) * Math.sin(��/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // Distance in meters
}

/**
 * Verify GPS location
 */
function verifyLocation(lat, lng) {
  const distance = calculateDistance(TAHFIZ_LAT, TAHFIZ_LNG, lat, lng);
  return {
    valid: distance <= ALLOWED_RADIUS,
    distance: Math.round(distance),
    maxDistance: ALLOWED_RADIUS
  };
}

/**
 * Handle check-in
 */
function handleCheckIn(params) {
  try {
    const userId = params.userId;
    // Parse latitude dan longitude - support both naming conventions
    const lat = parseFloat(params.latitude || params.lat);
    const lng = parseFloat(params.longitude || params.lng);

    Logger.log('CheckIn params: ' + JSON.stringify(params));
    Logger.log('Parsed lat: ' + lat + ', lng: ' + lng);

    if (!userId) {
      return createResponse(false, 'User ID diperlukan');
    }

    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
      return createResponse(false, 'Koordinat GPS tidak lengkap atau tidak sah. Lat: ' + lat + ', Lng: ' + lng);
    }

    // Get user info
    const userSheet = getSheet(SHEET_USERS);
    const userData = userSheet.getDataRange().getValues();
    let userName = 'Unknown';
    let email = 'unknown@email.com';

    for (let i = 1; i < userData.length; i++) {
      if (userData[i][0] === userId) {
        userName = userData[i][3]; // Name column
        email = userData[i][1];    // Email column
        break;
      }
    }

    // Verify location
    const locationCheck = verifyLocation(lat, lng);

    if (!locationCheck.valid) {
      return createResponse(false,
        `Anda berada ${locationCheck.distance}m dari tahfiz. Sila berada dalam radius ${locationCheck.maxDistance}m`
      );
    }

    const sheet = getSheet(SHEET_ATTENDANCE);
    const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');

    // Check if already checked in today
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userId && data[i][4] === today) {
        return createResponse(false, 'Anda sudah check-in hari ini');
      }
    }

    // Determine status based on time
    const now = new Date();
    const timeString = Utilities.formatDate(now, Session.getScriptTimeZone(), 'HH:mm:ss');
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const totalMinutes = hours * 60 + minutes;
    const checkInLimit = 8 * 60 + 15; // 08:15

    let status = 'Hadir';
    if (totalMinutes > checkInLimit) {
      status = 'Lewat';
    }

    // Add check-in record
    sheet.appendRow([
      generateId(),
      userId,
      userName,
      email,
      today,
      timeString,
      '', // CheckOut (empty)
      lat,
      lng,
      '', // CheckOutLat (empty)
      '', // CheckOutLng (empty)
      '', // Duration (empty)
      status,
      'Check-in: ' + locationCheck.distance + 'm dari tahfiz'
    ]);

    Logger.log('Check-in successful for user: ' + userName);

    return createResponse(true, 'Check-in berjaya! Jarak: ' + locationCheck.distance + 'm', {
      checkInTime: timeString,
      distance: locationCheck.distance,
      status: status,
      date: today,
      userName: userName,
      email: email
    });
  } catch (error) {
    Logger.log('Error in handleCheckIn: ' + error.message);
    Logger.log('Stack: ' + error.stack);
    return createResponse(false, 'Error check-in: ' + error.message);
  }
}

/**
 * Handle check-out
 */
function handleCheckOut(params) {
  try {
    const userId = params.userId;
    // Parse latitude dan longitude - support both naming conventions
    const lat = parseFloat(params.latitude || params.lat);
    const lng = parseFloat(params.longitude || params.lng);

    Logger.log('CheckOut params: ' + JSON.stringify(params));
    Logger.log('Parsed lat: ' + lat + ', lng: ' + lng);

    if (!userId) {
      return createResponse(false, 'User ID diperlukan');
    }

    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
      return createResponse(false, 'Koordinat GPS tidak lengkap atau tidak sah');
    }

    // Verify location
    const locationCheck = verifyLocation(lat, lng);

    if (!locationCheck.valid) {
      return createResponse(false,
        `Anda berada ${locationCheck.distance}m dari tahfiz. Sila berada dalam radius ${locationCheck.maxDistance}m`
      );
    }

    const sheet = getSheet(SHEET_ATTENDANCE);
    const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
    const data = sheet.getDataRange().getValues();

    // Find today's check-in record
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userId && data[i][4] === today && data[i][6] === '') {
        const now = new Date();
        const timeString = Utilities.formatDate(now, Session.getScriptTimeZone(), 'HH:mm:ss');

        // Calculate duration
        const checkInTime = new Date(today + ' ' + data[i][5]);
        const checkOutTime = now;
        const durationMs = checkOutTime - checkInTime;
        const hours = Math.floor(durationMs / 3600000);
        const minutes = Math.floor((durationMs % 3600000) / 60000);
        const duration = hours + 'h ' + minutes + 'm';

        // Update check-out
        sheet.getRange(i + 1, 7).setValue(timeString); // CheckOut (Column G)
        sheet.getRange(i + 1, 10).setValue(lat); // CheckOutLat (Column J)
        sheet.getRange(i + 1, 11).setValue(lng); // CheckOutLng (Column K)
        sheet.getRange(i + 1, 12).setValue(duration); // Duration (Column L)
        sheet.getRange(i + 1, 14).setValue(data[i][13] + ' | Check-out: ' + locationCheck.distance + 'm'); // Notes

        Logger.log('Check-out successful for user: ' + data[i][2]);

        return createResponse(true, 'Check-out berjaya! Durasi: ' + duration, {
          checkOutTime: timeString,
          duration: duration,
          distance: locationCheck.distance,
          checkInTime: data[i][5],
          status: data[i][12],
          date: today
        });
      }
    }

    Logger.log('No check-in record found for user: ' + userId + ' on date: ' + today);
    return createResponse(false, 'Tiada rekod check-in untuk hari ini');
  } catch (error) {
    Logger.log('Error in handleCheckOut: ' + error.message);
    Logger.log('Stack: ' + error.stack);
    return createResponse(false, 'Error check-out: ' + error.message);
  }
}

/**
 * Get attendance records
 */
function getAttendanceRecords(params) {
  const userId = params.userId;
  const role = params.role;
  const startDate = params.startDate;
  const endDate = params.endDate;

  const sheet = getSheet(SHEET_ATTENDANCE);
  const data = sheet.getDataRange().getValues();
  const records = [];

  // Skip header
  for (let i = 1; i < data.length; i++) {
    const row = data[i];

    // Filter by user (if not admin)
    if (role !== 'Admin' && row[1] !== userId) {
      continue;
    }

    // Filter by date range
    if (startDate && row[4] < startDate) continue;
    if (endDate && row[4] > endDate) continue;

    records.push({
      id: row[0],
      userId: row[1],
      userName: row[2],
      email: row[3],
      date: row[4],
      checkIn: row[5],
      checkOut: row[6],
      checkInLat: row[7],
      checkInLng: row[8],
      checkOutLat: row[9],
      checkOutLng: row[10],
      duration: row[11],
      status: row[12],
      notes: row[13]
    });
  }

  return createResponse(true, 'Rekod berjaya diambil', records);
}

/**
 * Get user statistics
 */
function getUserStats(params) {
  const userId = params.userId;
  const month = params.month || Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM');

  const sheet = getSheet(SHEET_ATTENDANCE);
  const data = sheet.getDataRange().getValues();

  let totalPresent = 0;
  let totalLate = 0;
  let totalHours = 0;

  for (let i = 1; i < data.length; i++) {
    const row = data[i];

    if (row[1] === userId && row[4].indexOf(month) === 0) {
      if (row[12] === 'Present') totalPresent++;
      if (row[12] === 'Late') totalLate++;

      // Parse duration
      if (row[11]) {
        const duration = row[11].toString();
        const hours = parseInt(duration.match(/(\d+)h/)?.[1] || 0);
        const minutes = parseInt(duration.match(/(\d+)m/)?.[1] || 0);
        totalHours += hours + (minutes / 60);
      }
    }
  }

  return createResponse(true, 'Statistik berjaya diambil', {
    totalPresent: totalPresent,
    totalLate: totalLate,
    totalHours: Math.round(totalHours * 10) / 10,
    month: month
  });
}

/**
 * Add new user (Admin only)
 */
function addUser(params) {
  const sheet = getSheet(SHEET_USERS);
  const data = sheet.getDataRange().getValues();

  // Check if userId provided, otherwise generate new one
  let userId = params.userId;
  if (!userId) {
    // Generate random 6 digit ID
    userId = generateUserId();

    // Check if generated ID already exists
    let attempts = 0;
    while (attempts < 10) {
      let exists = false;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === userId) {
          exists = true;
          break;
        }
      }
      if (!exists) break;
      userId = generateUserId();
      attempts++;
    }
  } else {
    // Validate userId is 6 digits
    if (!/^\d{6}$/.test(userId)) {
      return createResponse(false, 'UserID mesti 6 digit nombor');
    }

    // Check if userId already exists
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === userId) {
        return createResponse(false, 'UserID sudah wujud');
      }
    }
  }

  // Check if email already exists (if provided)
  if (params.email) {
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === params.email) {
        return createResponse(false, 'Email sudah wujud');
      }
    }
  }

  const hashedPassword = hashPassword(params.password);

  sheet.appendRow([
    userId,
    params.email || '',
    hashedPassword,
    params.name,
    params.role || 'guru',
    params.status || 'Active',
    new Date().toISOString(),
    ''
  ]);

  return createResponse(true, 'Pengguna berjaya ditambah', {
    userId: userId,
    name: params.name
  });
}

/**
 * Update user (Admin only)
 */
function updateUser(params) {
  const sheet = getSheet(SHEET_USERS);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === params.userId) {
      if (params.name) sheet.getRange(i + 1, 4).setValue(params.name);
      if (params.role) sheet.getRange(i + 1, 5).setValue(params.role);
      if (params.status) sheet.getRange(i + 1, 6).setValue(params.status);
      if (params.password) {
        sheet.getRange(i + 1, 3).setValue(hashPassword(params.password));
      }

      return createResponse(true, 'Pengguna berjaya dikemaskini');
    }
  }

  return createResponse(false, 'Pengguna tidak dijumpai');
}

/**
 * Delete user (Admin only)
 */
function deleteUser(params) {
  const sheet = getSheet(SHEET_USERS);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === params.userId) {
      sheet.deleteRow(i + 1);
      return createResponse(true, 'Pengguna berjaya dipadam');
    }
  }

  return createResponse(false, 'Pengguna tidak dijumpai');
}

/**
 * Get all users (Admin only)
 */
function getAllUsers() {
  const sheet = getSheet(SHEET_USERS);
  const data = sheet.getDataRange().getValues();
  const users = [];

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    users.push({
      id: row[0],
      email: row[1],
      name: row[3],
      role: row[4],
      status: row[5],
      created: row[6],
      lastLogin: row[7]
    });
  }

  return createResponse(true, 'Senarai pengguna berjaya diambil', users);
}

/**
 * Get single user by ID
 */
function getUser(params) {
  const userId = params.userId;

  if (!userId) {
    return createResponse(false, 'User ID diperlukan');
  }

  const sheet = getSheet(SHEET_USERS);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === userId) {
      return createResponse(true, 'Pengguna dijumpai', {
        id: data[i][0],
        email: data[i][1],
        name: data[i][3],
        role: data[i][4],
        status: data[i][5],
        created: data[i][6],
        lastLogin: data[i][7]
      });
    }
  }

  return createResponse(false, 'Pengguna tidak dijumpai');
}

/**
 * Get today's attendance for all users (Admin)
 */
function getTodayAttendance() {
  const sheet = getSheet(SHEET_ATTENDANCE);
  const today = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
  const data = sheet.getDataRange().getValues();
  const records = [];

  for (let i = 1; i < data.length; i++) {
    if (data[i][4] === today) {
      records.push({
        id: data[i][0],
        userId: data[i][1],
        userName: data[i][2],
        email: data[i][3],
        date: data[i][4],
        checkIn: data[i][5],
        checkOut: data[i][6],
        checkInLat: data[i][7],
        checkInLng: data[i][8],
        checkOutLat: data[i][9],
        checkOutLng: data[i][10],
        duration: data[i][11],
        status: data[i][12],
        notes: data[i][13]
      });
    }
  }

  return createResponse(true, 'Rekod kehadiran hari ini berjaya diambil', records);
}

/**
 * Submit note/catatan (User)
 */
function submitNote(params) {
  try {
    const userId = params.userId;
    const userName = params.userName;
    const email = params.email;
    const noteType = params.noteType;
    const noteDate = params.noteDate;
    const noteReason = params.noteReason;
    const submittedDate = params.submittedDate;

    // Validation
    if (!userId || !userName || !noteType || !noteDate || !noteReason) {
      return createResponse(false, 'Data tidak lengkap');
    }

    Logger.log('Submitting note for user: ' + userName);

    const sheet = getSheet(SHEET_NOTES);

    // Add note record
    sheet.appendRow([
      generateId(),
      userId,
      userName,
      email || '',
      noteType,
      noteDate,
      noteReason,
      submittedDate,
      'Pending',  // Status
      '',         // AdminResponse
      ''          // AdminRespondedDate
    ]);

    Logger.log('Note submitted successfully');

    return createResponse(true, 'Catatan berjaya dihantar', {
      userId: userId,
      noteType: noteType,
      noteDate: noteDate
    });

  } catch (error) {
    Logger.log('Error in submitNote: ' + error.message);
    return createResponse(false, 'Error submit note: ' + error.message);
  }
}

/**
 * Get all notes (Admin)
 */
function getAllNotes() {
  try {
    const sheet = getSheet(SHEET_NOTES);
    const data = sheet.getDataRange().getValues();
    const notes = [];

    // Skip header row
    for (let i = 1; i < data.length; i++) {
      notes.push({
        id: data[i][0],
        userId: data[i][1],
        userName: data[i][2],
        email: data[i][3],
        noteType: data[i][4],
        noteDate: data[i][5],
        noteReason: data[i][6],
        submittedDate: data[i][7],
        status: data[i][8],
        adminResponse: data[i][9],
        adminRespondedDate: data[i][10]
      });
    }

    return createResponse(true, 'Senarai catatan berjaya diambil', notes);

  } catch (error) {
    Logger.log('Error in getAllNotes: ' + error.message);
    return createResponse(false, 'Error get notes: ' + error.message);
  }
}

/**
 * Get notes by user ID
 */
function getNotesByUser(params) {
  try {
    const userId = params.userId;

    if (!userId) {
      return createResponse(false, 'User ID diperlukan');
    }

    const sheet = getSheet(SHEET_NOTES);
    const data = sheet.getDataRange().getValues();
    const notes = [];

    // Skip header row
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userId) {
        notes.push({
          id: data[i][0],
          userId: data[i][1],
          userName: data[i][2],
          email: data[i][3],
          noteType: data[i][4],
          noteDate: data[i][5],
          noteReason: data[i][6],
          submittedDate: data[i][7],
          status: data[i][8],
          adminResponse: data[i][9],
          adminRespondedDate: data[i][10]
        });
      }
    }

    return createResponse(true, 'Catatan pengguna berjaya diambil', notes);

  } catch (error) {
    Logger.log('Error in getNotesByUser: ' + error.message);
    return createResponse(false, 'Error get user notes: ' + error.message);
  }
}


// ============================================
// TAMAT - Code.gs
// ============================================


// ============================================
// CARA SETUP:
// ============================================
// 1. Buat Google Sheet baru
// 2. Salin SPREADSHEET_ID dari URL (contoh: docs.google.com/spreadsheets/d/SPREADSHEET_ID_HERE/edit)
// 3. Tukar SPREADSHEET_ID di atas dengan ID anda
// 4. Tukar TAHFIZ_LAT dan TAHFIZ_LNG dengan koordinat tahfiz anda
// 5. Pergi Tools > Script Editor
// 6. Padam semua kod dan ganti dengan kod di atas
// 7. Klik Deploy > New deployment
// 8. Pilih "Web app"
// 9. Execute as: Me
// 10. Who has access: Anyone
// 11. Klik Deploy
// 12. Copy Web App URL dan guna dalam config.js
//
// Akaun default:
// Admin: admin@tahfiz.com / admin123
// Guru: guru@tahfiz.com / guru123
// ============================================
